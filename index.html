<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Live Mirror AI - V51.0 Final Fix</title>
    <style>
        /* M28 è¦–è¦ºå‚³æ’­ï¼šé»‘é‡‘ç¦ªæ„é¢¨æ ¼ */
        :root { --bg-color: #050505; --panel-bg: #111111; --accent-color: #c5a059; --text-primary: #e0e0e0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #app-window { width: 100%; height: 100dvh; max-width: 500px; background: var(--panel-bg); display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 0 60px rgba(0,0,0,0.9); }
        
        header { padding: 15px; text-align: center; border-bottom: 1px solid #222; font-weight: bold; flex: none; font-size: 18px; display: flex; justify-content: center; align-items: center; gap: 8px; color: var(--accent-color); letter-spacing: 1px; }
        .version-tag { font-size: 10px; background: linear-gradient(45deg, var(--accent-color), #ffd700); padding: 2px 6px; border-radius: 4px; color: #000; font-weight: 900; }

        .stage { flex: 1; display: none; flex-direction: column; align-items: center; padding: 20px 15px; overflow-y: auto; overflow-x: hidden; }
        .active { display: flex; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* V51.0: å…¨åŸŸçµ±ä¸€ä½¿ç”¨ 3:4 æ¯”ä¾‹å®¹å™¨ï¼Œç¢ºä¿ä¸éé•· */
        .viewport-container { 
            width: 100%; 
            aspect-ratio: 3 / 4; /* é—œéµï¼šé–å®š 3:4 */
            max-height: 60vh; 
            background: #000; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-bottom: 15px; 
            flex: none; 
            border: 1px solid #333; 
        }
        
        /* æ‹ç…§èˆ‡é è¦½ä½¿ç”¨ cover å¡«æ»¿ */
        video.mirror { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        img#preview-img { width: 100%; height: 100%; object-fit: cover; } 
        
        #preview-img, #final-result { display: none; }
        #preview-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: #080808; }
        .placeholder-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

        /* é–‹å ´ç™½ */
        #stage-intro { justify-content: center; text-align: center; padding: 30px; }
        .intro-text { font-size: 16px; line-height: 1.8; color: #ccc; margin-bottom: 30px; text-align: left; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        .highlight { color: var(--accent-color); font-weight: bold; text-decoration: underline; text-decoration-color: rgba(197, 160, 89, 0.3); text-underline-offset: 4px; }

        /* V51.0: æŒ‰éˆ•å„ªåŒ– - ä¿®æ­£æ“ å£“å•é¡Œ */
        .btn-action { 
            padding: 0 20px; /* å¢åŠ æ°´å¹³å…§è· */
            height: 60px; 
            /* remove fixed line-height, use flex positioning */
            border-radius: 30px; 
            border: none; 
            background: linear-gradient(135deg, var(--accent-color), #aa8a2e); 
            color: #000; 
            font-size: 18px; /* å¾®èª¿å­—é«”å¤§å°è‡³ 18px */
            font-weight: 900; 
            cursor: pointer; 
            box-shadow: 0 6px 20px rgba(197, 160, 89, 0.4); 
            width: 90%; 
            max-width: 300px; /* æ”¾å¯¬æœ€å¤§å¯¬åº¦ */
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            transition: transform 0.1s; 
            outline: none; 
            margin-top: 15px; 
            letter-spacing: 1px;
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ›è¡Œ */
        }
        .btn-action:active { transform: scale(0.96); }

        .gender-toggle { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .gender-option { flex: 1; text-align: center; padding: 12px; background: #252525; border-radius: 12px; border: 1px solid #444; cursor: pointer; font-weight: bold; color: #888; font-size: 16px; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .gender-option.selected { background: var(--accent-color); color: #000; border-color: var(--accent-color); box-shadow: 0 0 15px rgba(197, 160, 89, 0.3); }

        .dna-section { width: 100%; background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .dna-title { font-size: 14px; color: var(--accent-color); margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .tag-check { display: none; }
        .tag-label { padding: 8px 12px; background: #252525; border-radius: 20px; font-size: 13px; color: #999; cursor: pointer; border: 1px solid #444; transition: all 0.2s; user-select: none; }
        .tag-check:checked + .tag-label { background: var(--accent-color); color: black; border-color: var(--accent-color); font-weight: bold; }

        .style-category-title { width: 100%; font-size: 12px; color: #666; margin-top: 15px; margin-bottom: 8px; text-align: left; padding-left: 5px; border-left: 3px solid var(--accent-color); letter-spacing: 1px; }
        .style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; margin-bottom: 5px; }
        .style-card { background: #2a2a2a; border: 1px solid #444; border-radius: 12px; padding: 15px 5px; cursor: pointer; text-align: center; font-size: 15px; position: relative; overflow: hidden; transition: all 0.2s; display: flex; align-items: center; justify-content: center; min-height: 50px; }
        .style-card:active { transform: scale(0.96); background: #444; }
        .style-elf { border: 1px solid var(--accent-color); background: rgba(197, 160, 89, 0.1); color: var(--accent-color); font-weight: bold; }
        .style-tao { border: 1px solid #fff; background: linear-gradient(45deg, #2a2a2a, #555); color: white; }

        #start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        select.camera-select { width: 100%; padding: 12px; margin-bottom: 20px; background: #333; color: white; border: 1px solid #555; border-radius: 10px; font-size: 16px; outline: none; }
        
        #canvas-comp, #canvas-resize, #canvas { display: none !important; }
        
        .progress-wrapper { width: 85%; position: relative; margin-top: 30px; }
        .progress-text { position: absolute; top: -25px; right: 0; color: var(--accent-color); font-weight: bold; font-size: 14px; }

        /* V51.0: çµæœé é‡æ–°é–å®š 3:4ï¼Œä¸¦ä½¿ç”¨ contain ç¢ºä¿ä¸è®Šå½¢ */
        #stage-4 .viewport-container { 
            aspect-ratio: 3 / 4; 
            background: transparent; 
            border: none; 
        }
        img#final-result { 
            width: 100%;
            height: 100%;
            object-fit: contain; /* é—œéµï¼šä¿æŒåŸæ¯”ä¾‹å®Œæ•´é¡¯ç¤ºåœ¨ 3:4 æ¡†å…§ */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-radius: 8px;
        }
    </style>
</head>
<body>

<div id="app-window">
    <header>
        Live Mirror AI <span class="version-tag">V51.0 Final Fix</span>
    </header>

    <div id="stage-intro" class="stage active" style="display: flex;">
        <div class="intro-text">
            ã€Œç›¸æ©Ÿæ‹çš„æ˜¯ä½ çš„ã€çš®å›Šã€ï¼Œ<br>ä½†é€™å€‹ AI ç•«å®¶ç•«çš„æ˜¯ä½ çš„<br><span class="highlight">ã€æ°£å ´ã€èˆ‡ã€ç²¾æ°£ç¥ã€</span>ã€‚<br><br>
            ã€Šé“å¾·ç¶“ã€‹èªªã€å¤§è±¡ç„¡å½¢ã€ã€‚<br>AI é€éé¡é ­æ„Ÿæ‡‰åˆ°äº†ä½ å…§åœ¨çš„èƒ½é‡ã€‚<br><br>
            <span class="highlight">ä¸è¦åŸ·è‘—æ–¼ã€åƒä¸åƒã€ï¼Œ<br>è¦çœ‹å®ƒæœ‰æ²’æœ‰æŠ“åˆ°ä½ çš„ã€ç¥ã€ã€‚</span>ã€
        </div>
        <button class="btn-action" onclick="startExperience()">âœ¨ é–‹å§‹é«”é©—</button>
    </div>

    <div id="start-overlay" style="display: none;">
        <h1 style="color:white; margin-bottom:10px; font-size: 24px;">ğŸ“· é€£çµéˆé­‚ä¹‹çª—</h1>
        <p style="color:#aaa; margin-bottom:30px; font-size: 14px;">è«‹å…è¨±ç›¸æ©Ÿæ¬Šé™</p>
        <div id="step-permission">
            <button class="btn-action" onclick="initCameraMode()">ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ</button>
        </div>
        <div id="step-selection" style="display:none; width:100%; margin-top: 20px;">
            <p style="color:white; margin-bottom:15px;">è«‹é¸æ“‡é¡é ­ï¼š</p>
            <select id="camera-list" class="camera-select"></select>
            <div style="display:flex; justify-content:center;"><button class="btn-action" onclick="confirmCamera()">âœ… ç¢ºèªé¡é ­</button></div>
        </div>
        <p id="error-msg" style="color: #ff5c5c; font-size: 12px; margin-top: 20px; max-width: 80%;"></p>
    </div>

    <div id="stage-1" class="stage">
        <div class="viewport-container">
            <video id="webcam" playsinline class="mirror" autoplay muted></video>
        </div>
        <button class="btn-action" onclick="capturePhoto()">ğŸ“¸ æ‹ ç…§</button>
        <p style="margin-top:20px; font-size:14px; color:#666; cursor:pointer; text-decoration: underline;" onclick="location.reload()">[è¿”å›é¦–é ]</p>
    </div>

    <div id="stage-2" class="stage">
        <div class="viewport-container" style="border: 2px solid var(--accent-color);">
            <div id="preview-placeholder">
                <div class="placeholder-icon">ğŸ–¼ï¸</div>
                <span>ç­‰å¾…ç…§ç‰‡è¼‰å…¥...</span>
            </div>
            <img id="preview-img" src="">
        </div>
        
        <div class="gender-toggle">
            <div class="gender-option" onclick="switchGender('boy')" id="btn-boy">ğŸ‘¦ ç”·ç”Ÿ</div>
            <div class="gender-option selected" onclick="switchGender('girl')" id="btn-girl">ğŸ‘§ å¥³ç”Ÿ</div>
        </div>

        <div class="dna-section">
            <div class="dna-title">ğŸ§¬ é¸æ“‡æ‚¨çš„ç‰¹å¾µ (æ™ºèƒ½äº’æ–¥)</div>
            <div class="tags-container">
                <label><input type="checkbox" class="tag-check" value="wearing glasses" onchange="checkMutex(this)"><span class="tag-label">ğŸ‘“ çœ¼é¡</span></label>
                <label><input type="checkbox" class="tag-check" value="short hair" onchange="checkMutex(this)"><span class="tag-label">ğŸ’‡ çŸ­é«®</span></label>
                <label><input type="checkbox" class="tag-check" value="long hair" onchange="checkMutex(this)"><span class="tag-label">ğŸ‘±â€â™€ï¸ é•·é«®</span></label>
                <label><input type="checkbox" class="tag-check" value="curly hair" onchange="checkMutex(this)"><span class="tag-label">â° æ²é«®</span></label>
                <label><input type="checkbox" class="tag-check" value="beard" onchange="checkMutex(this)"><span class="tag-label">ğŸ§” é¬å­</span></label>
                <label><input type="checkbox" class="tag-check" value="smile" checked onchange="checkMutex(this)"><span class="tag-label">ğŸ˜„ ç¬‘å®¹</span></label>
                <label><input type="checkbox" class="tag-check" value="child" onchange="checkMutex(this)"><span class="tag-label">ğŸ‘¶ ç«¥é¡</span></label>
                <label><input type="checkbox" class="tag-check" value="elder" onchange="checkMutex(this)"><span class="tag-label">ğŸ§“ é•·è¼©</span></label>
                <label><input type="checkbox" class="tag-check" value="wearing suit" onchange="checkMutex(this)"><span class="tag-label">ğŸ‘” æ­£è£</span></label>
                <label><input type="checkbox" class="tag-check" value="wearing hat" onchange="checkMutex(this)"><span class="tag-label">ğŸ§¢ å¸½å­</span></label>
            </div>
        </div>

        <div class="style-category-title">ğŸŒŸ ç¨å®¶ç²¾é¸</div>
        <div class="style-grid">
            <div class="style-card style-elf" onclick="generateAI('elf')">ğŸ§š è™›å¹»ç²¾éˆ</div>
            <div class="style-card style-tao" onclick="generateAI('taoist')">ğŸ•Šï¸ ç™½é™½è–æ½”</div>
        </div>

        <div class="style-category-title">ğŸ¨ å‹•æ¼«æ¬¡å…ƒ</div>
        <div class="style-grid">
            <div class="style-card" onclick="generateAI('pixar')">ğŸ§¸ çš®å…‹æ–¯é¢¨</div>
            <div class="style-card" onclick="generateAI('ghibli')">ğŸƒ å‰åœåŠ›é¢¨</div>
            <div class="style-card" onclick="generateAI('comic')">ğŸ’¥ ç¾å¼æ¼«ç•«</div>
        </div>

        <div class="style-category-title">ğŸ–Œï¸ è—è¡“è³ªæ„Ÿ</div>
        <div class="style-grid">
            <div class="style-card" onclick="generateAI('cyberpunk')">ğŸŒƒ è³½åšé¾å…‹</div>
            <div class="style-card" onclick="generateAI('oil')">ğŸ¨ æ¢µè°·æ²¹ç•«</div>
            <div class="style-card" onclick="generateAI('ink')">ğŸ–Œï¸ æ±æ–¹æ°´å¢¨</div>
        </div>

        <button style="margin-top:20px; background:transparent; border:none; color:#666; font-size:14px;" onclick="location.reload()">â¬…ï¸ è¿”å›é‡æ‹</button>
    </div>

    <div id="stage-3" class="stage" style="justify-content: center;">
        <h2 id="loading-text" style="color: var(--accent-color); font-size: 22px;">âš¡ è™•ç†ä¸­...</h2>
        <div class="progress-wrapper">
            <span id="progress-percent" class="progress-text">0%</span>
            <div style="width:100%; height:10px; background:#333; border-radius:5px; overflow: hidden;">
                <div id="progress-bar" style="width:0%; height:100%; background: linear-gradient(90deg, var(--accent-color), #fff); transition:width 0.3s;"></div>
            </div>
        </div>
        <p id="prompt-debug" style="color:#888; font-size:12px; margin-top:15px; max-width:80%; text-align:center;">æ­£åœ¨åˆå§‹åŒ–...</p>
    </div>

    <div id="stage-4" class="stage">
        <h2 style="color: var(--accent-color); font-size: 22px;">âœ¨ æ‚¨çš„éˆé­‚ç•«åƒ</h2>
        <div class="viewport-container">
            <div id="result-placeholder" style="display:block; color:#555;">æ­£åœ¨è£è£±...</div>
            <img id="final-result" src="">
        </div>
        <p style="color: var(--accent-color); font-weight: bold; font-size: 16px; margin-top: 15px;">ğŸ‘‡ é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ‘‡</p>
        <div style="font-size: 13px; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; text-align: center;">
            åˆ†äº«é€£çµï¼š
            <div id="qrcode-container" style="margin-top: 10px; background: white; padding: 10px; display: inline-block; border-radius: 12px;"></div>
        </div>
        <button class="btn-action" onclick="location.reload()" style="background: #333; color:white; font-size:15px; margin-top: 30px; max-width:none; border: 1px solid #555; padding: 12px 0; width: 200px;">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <canvas id="canvas-comp"></canvas>
    <canvas id="canvas-resize"></canvas>
    <canvas id="canvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const video = document.getElementById('webcam'), previewImg = document.getElementById('preview-img'), finalImg = document.getElementById('final-result'), cameraList = document.getElementById('camera-list'), errorMsg = document.getElementById('error-msg');
    const canvasComp = document.getElementById('canvas-comp'); const canvasResize = document.getElementById('canvas-resize');
    let retryCount = 0; const maxRetries = 2; let progressInterval;

    window.onerror = function(msg, url, line, col, error) {
        console.error("Global Error:", msg, error);
        if(document.getElementById('stage-3').style.display === 'flex') {
            composeDirectly("âš ï¸ ç³»çµ±å¿™ç¢Œï¼Œå·²ç‚ºæ‚¨åˆ‡æ›è‡³å¿«é€Ÿæ¨¡å¼");
        }
    };

    // ç‰¹å¾µäº’æ–¥é‚è¼¯
    function checkMutex(el) {
        const val = el.value;
        if (!el.checked) return; 

        const uncheck = (v) => {
            const target = document.querySelector(`input[value="${v}"]`);
            if (target && target.checked) target.checked = false;
        };

        if (val === 'short hair') uncheck('long hair');
        if (val === 'long hair') uncheck('short hair');
        
        if (val === 'child') {
            uncheck('elder');
            uncheck('beard');
        }
        if (val === 'elder') uncheck('child');
        
        if (val === 'beard') uncheck('child');
    }

    function startExperience() {
        document.getElementById('stage-intro').style.display = 'none';
        document.getElementById('stage-intro').classList.remove('active');
        document.getElementById('start-overlay').style.display = 'flex';
    }

    async function initCameraMode() {
        errorMsg.innerText = "";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            await listCameras();
            stream.getTracks().forEach(track => track.stop());
            document.getElementById('step-permission').style.display = 'none';
            document.getElementById('step-selection').style.display = 'block';
        } catch (err) { console.error(err); errorMsg.innerText = "å•Ÿå‹•å¤±æ•—ï¼šè«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±ç›¸æ©Ÿæ¬Šé™(NotAllowedError)ã€‚"; }
    }

    async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        cameraList.innerHTML = '';
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option'); option.value = device.deviceId;
            let label = device.label || `ç›¸æ©Ÿ ${index + 1}`;
            if (label.toLowerCase().includes('back') || label.includes('å¾Œ')) label = "ğŸ“¸ å¾Œç½®é¡é ­"; else if (label.toLowerCase().includes('front') || label.includes('å‰')) label = "ğŸ‘¤ å‰ç½®è‡ªæ‹";
            option.text = label; cameraList.appendChild(option);
        });
    }

    async function confirmCamera() {
        const deviceId = cameraList.value;
        const constraints = { video: { deviceId: { exact: deviceId }, aspectRatio: 0.75, width: { ideal: 720 }, height: { ideal: 960 } } };
        try { const stream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject = stream; document.getElementById('start-overlay').style.display = 'none'; switchStage('stage-1'); } catch (err) { 
            try { const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } }); video.srcObject = stream; document.getElementById('start-overlay').style.display = 'none'; switchStage('stage-1'); } catch (fatalErr) { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚"); } 
        }
    }

    function processInputImage(imgElement, isCamera = false) {
        const MAX_WORK_SIZE = 1024; 
        let w = imgElement.width || imgElement.videoWidth; let h = imgElement.height || imgElement.videoHeight;
        const ratio = w / h;
        if (w > h) { if (w > MAX_WORK_SIZE) { w = MAX_WORK_SIZE; h = w / ratio; } } 
        else { if (h > MAX_WORK_SIZE) { h = MAX_WORK_SIZE; w = h * ratio; } }
        
        canvasResize.width = w; canvasResize.height = h;
        const ctx = canvasResize.getContext('2d');
        if (isCamera) { ctx.translate(w, 0); ctx.scale(-1, 1); }
        ctx.drawImage(imgElement, 0, 0, w, h);
        previewImg.src = canvasResize.toDataURL('image/jpeg', 0.95);
        previewImg.style.display = 'block';
        document.getElementById('preview-placeholder').style.display = 'none';
        document.getElementById('start-overlay').style.display = 'none'; 
        switchStage('stage-2');
    }

    function capturePhoto() { processInputImage(video, true); }

    let currentGender = 'girl';
    function switchGender(g) { 
        currentGender = g; 
        document.getElementById('btn-boy').classList.toggle('selected', g==='boy'); 
        document.getElementById('btn-girl').classList.toggle('selected', g==='girl'); 
    }
    window.onload = () => { switchGender('girl'); };

    function getDNA() {
        const checkboxes = document.querySelectorAll('.tag-check:checked');
        let tags = [];
        checkboxes.forEach(cb => tags.push(cb.value));
        return tags.join(", ");
    }

    function generateAI(styleKey) { 
        switchStage('stage-3');
        document.getElementById('loading-text').innerText = "âš¡ AI ç¹ªåœ–ä¸­...";
        simulateProgress();
        retryCount = 0;
        tryLoadAI(styleKey, 768, 1024);
    }

    function tryLoadAI(styleKey, width, height) {
        let dna = getDNA();
        let subject = currentGender === 'boy' ? "handsome man, male" : "beautiful woman, female";
        let fullPrompt = ""; 
        
        // V51.0: åœ¨æ‰€æœ‰ Prompt ä¸­å¼·åˆ¶åŠ å…¥ "aspect ratio 3:4" ä»¥è§£æ±ºé•·è‡‰å•é¡Œ
        const ratioFix = ", aspect ratio 3:4";

        if(styleKey === 'pixar') fullPrompt = `cute 3d pixar style portrait of ${subject}, ${dna}, highly detailed, studio lighting, big eyes, 8k, vertical composition${ratioFix}`; 
        else if(styleKey === 'ghibli') fullPrompt = `studio ghibli anime portrait of ${subject}, ${dna}, hayao miyazaki style, watercolor background, high quality, vertical composition${ratioFix}`; 
        else if(styleKey === 'cyberpunk') fullPrompt = `cyberpunk portrait of ${subject}, ${dna}, neon lights, mechanical parts, futuristic city background, realistic, vertical composition${ratioFix}`; 
        else if(styleKey === 'oil') fullPrompt = `van gogh oil painting portrait of ${subject}, ${dna}, thick brushstrokes, artistic, starry night background, vertical composition${ratioFix}`; 
        else if(styleKey === 'comic') fullPrompt = `american comic superhero portrait of ${subject}, ${dna}, bold lines, halftone dots, marvel style, vertical composition${ratioFix}`; 
        else if(styleKey === 'ink') fullPrompt = `chinese ink wash painting portrait of ${subject}, ${dna}, black and white, sumi-e, artistic, red stamp, vertical composition${ratioFix}`; 
        else if(styleKey === 'elf') fullPrompt = `(masterpiece), ethereal fantasy portrait of ${subject}, ${dna}, beautiful elf spirit, pointed ears, glowing skin, magical forest background, detailed face, 8k, vertical composition${ratioFix}`; 
        else if(styleKey === 'taoist') fullPrompt = `(masterpiece), traditional chinese ancient style portrait of ${subject}, ${dna}, righteous aura, white hanfu, taoist robe, ethereal atmosphere, soft lighting, temple background, lotus, hd, 8k, vertical composition${ratioFix}`; 

        const aiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=${width}&height=${height}&seed=${Math.floor(Math.random()*999999)}&nologo=true&model=flux&t=${Date.now()}`; 
        
        const tempImg = new Image();
        tempImg.crossOrigin = "anonymous";
        
        const watchdog = setTimeout(() => { handleAILoadError(styleKey, "è¶…æ™‚"); }, 40000);

        tempImg.onload = () => {
            clearTimeout(watchdog);
            composeFinalImage(aiUrl, "âš¡ AI ç¹ªåœ–å®Œæˆ...");
        };

        tempImg.onerror = () => {
            clearTimeout(watchdog);
            handleAILoadError(styleKey, "è¼‰å…¥å¤±æ•—");
        };
        tempImg.src = aiUrl;
    }

    function handleAILoadError(styleKey, reason) {
        retryCount++;
        const debug = document.getElementById('prompt-debug');
        if (retryCount <= maxRetries) {
            debug.innerText = `é€£ç·šç¹å¿™ï¼Œé™ç´šé‡è©¦ä¸­ (${retryCount}/${maxRetries})...`;
            setTimeout(() => { tryLoadAI(styleKey, 512, 768); }, 1500);
        } else {
            debug.innerText = "AI å¿™ç·šï¼Œåˆ‡æ›è‡³åŸåœ–è£è£±...";
            setTimeout(() => { composeDirectly("âš ï¸ AI å¿™ç·šï¼Œå·²ç‚ºæ‚¨ä½¿ç”¨åŸåœ–"); }, 200);
        }
    }

    function composeFinalImage(sourceImageUrl, loadingMsg) {
        document.getElementById('loading-text').innerText = loadingMsg || "âš¡ è™•ç†ä¸­..."; 
        document.getElementById('prompt-debug').innerText = "å½±åƒåˆæˆä¸­...";
        
        const baseImg = new Image();
        if (sourceImageUrl.startsWith('http')) { baseImg.crossOrigin = "anonymous"; }
        
        baseImg.onload = () => { processComposition(baseImg); };
        baseImg.onerror = () => { composeDirectly("âš ï¸ å½±åƒè™•ç†ç•°å¸¸ï¼Œä½¿ç”¨åŸåœ–å‚™ä»½"); }; 
        baseImg.src = sourceImageUrl;
    }

    function composeDirectly(loadingMsg) {
        document.getElementById('loading-text').innerText = loadingMsg;
        setTimeout(() => {
            const fallbackImg = new Image();
            fallbackImg.onload = () => { processComposition(fallbackImg); };
            fallbackImg.src = previewImg.src;
        }, 100);
    }

    function processComposition(imageSource) {
        try {
            const workW = imageSource.width || imageSource.naturalWidth;
            const workH = imageSource.height || imageSource.naturalHeight;

            canvasComp.width = workW; 
            canvasComp.height = workH;
            const ctx = canvasComp.getContext('2d');

            // ç°¡å–®ç›´æ¥ç¹ªè£½åœ–ç‰‡
            ctx.drawImage(imageSource, 0, 0);
            
            finalImg.src = canvasComp.toDataURL('image/png'); 
            finalImg.style.display = 'block';
            document.getElementById('result-placeholder').style.display = 'none';
            
            if(typeof progressInterval !== 'undefined') clearInterval(progressInterval);
            document.getElementById('progress-bar').style.width = '100%';
            
            document.getElementById('loading-text').innerText = "å®Œæˆï¼";
            setTimeout(() => {
                 document.getElementById("qrcode-container").innerHTML = ""; 
                 new QRCode(document.getElementById("qrcode-container"), { text: window.location.href, width: 120, height: 120 }); 
                 switchStage('stage-4');
            }, 100);

        } catch (e) {
            console.error(e);
            finalImg.src = previewImg.src;
            finalImg.style.display = 'block';
            switchStage('stage-4');
        }
    }

    function simulateProgress() { const bar = document.getElementById('progress-bar'); const text = document.getElementById('progress-percent'); const debug = document.getElementById('prompt-debug'); let w = 0; progressInterval = setInterval(() => { if(w>=99) clearInterval(progressInterval); if(w < 50) w += Math.random() * 5; else if(w < 80) w += Math.random() * 2; else w += Math.random() * 0.5; w = Math.min(w, 99); bar.style.width = w + '%'; text.innerText = Math.floor(w) + '%'; if(w < 30) debug.innerText = "æ­£åœ¨æ§‹æ€ç•«é¢ç´°ç¯€..."; else if(w < 60) debug.innerText = "AI å¤§å¸«æ®æ¯«ä¸­..."; else if(w < 90) debug.innerText = "æ­£åœ¨é€²è¡Œå…‰å½±æ¸²æŸ“..."; else debug.innerText = "æœ€å¾Œä¿®é£¾..."; }, 500); }
    function switchStage(id) { document.querySelectorAll('.stage').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); }); const target = document.getElementById(id); target.style.display = 'flex'; setTimeout(()=>target.classList.add('active'), 10); }
</script>
</body>
</html>